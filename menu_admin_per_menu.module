<?php

/**
 * @file
 * Module file for menu_admin_per_menu.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Element;
use Drupal\menu_ui\MenuForm;
use Drupal\menu_ui\Form\MenuLinkEditForm;
use Drupal\menu_link_content\Form\MenuLinkContentForm;

/**
 * Implementation of hook_form_alter().
 */
function menu_admin_per_menu_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form_object = $form_state->getFormObject();
  if ($form_object instanceof MenuLinkEditForm
    || $form_object instanceof MenuLinkContentForm) {
    $account = \Drupal::currentUser();
    if (!$account->hasPermission('administer menu')) {
      menu_admin_per_menu_filter_parent_options($form['menu_parent']['#options']);
    }
  }
  if ($form_object instanceof MenuForm) {
    $account = \Drupal::currentUser();
    if (!$account->hasPermission('administer menu')) {
      $form['id']['#access'] = FALSE;
      $form['label']['#access'] = FALSE;
      $form['description']['#access'] = FALSE;
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form.
 */
function menu_admin_per_menu_form_node_form_alter(&$form, FormStateInterface $form_state) {
  $account = \Drupal::currentUser();
  if (!$account->hasPermission('administer menu')) {
    $menu_options = &$form['menu']['link']['menu_parent']['#options'];
    $menu_exist = menu_admin_per_menu_filter_parent_options($menu_options);
    if ($menu_exist){
      $form['menu']['link']['menu_parent']['#default_value'] = reset($menu_options);
    }
    else {
      $form['menu']['#access'] = FALSE;
    }
  }
}

/**
 * Deletes not accessible menu items from select element for current user.
 *
 * @param array &$element
 *   Reference to form select element with menu items.
 *
 * @return bool
 *   FALSE if there is no accessible menu items,
 *   TRUE if we have some accessible menu items.
 */
function menu_admin_per_menu_filter_parent_options(&$element) {
  $accessible_menus = menu_admin_per_menu_get_accessible_menus();
  if (count($accessible_menus) && is_array($element)) {
    $option_keys = array_keys($element);
    foreach ($option_keys as $option_key) {
      list($menu, $item) = explode(':', $option_key);
      if (!in_array($menu, $accessible_menus)) {
        unset($element[$option_key]);
      }
    }
    return count($element);
  }
  return FALSE;
}

/**
 * Returns an array of the accessible menus for current user.
 *
 * @return array
 *   An array with the menus machine-readable names as values.
 */
function menu_admin_per_menu_get_accessible_menus() {
  $account = \Drupal::currentUser();
  $accessible_menus = array();
  $menus = menu_ui_get_menus();
  foreach ($menus as $name => $title) {
    if ($account->hasPermission('administer ' . $name . ' menu items')) {
      $accessible_menus[] = $name;
    }
  }
  return $accessible_menus;
}
